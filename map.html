<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式世界地圖 - 專業完整版</title>
    
    <!-- 引入 D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- 引入 TopoJSON -->
    <script src="https://unpkg.com/topojson-client@3"></script>

    <style>
        :root {
            /* 海洋顏色：保持清爽的淺藍色 */
            --ocean-color: #E1F5FE; 
            --modal-bg: #ffffff;
            --text-primary: #263238;
            --text-secondary: #546E7A;
            --highlight-stroke: #263238;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: "Microsoft JhengHei", "PingFang TC", "Heiti TC", sans-serif;
            background-color: var(--ocean-color);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 標題 */
        h1 {
            position: absolute;
            top: 20px;
            z-index: 10;
            color: #37474F;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 12px 40px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            margin: 0;
            font-size: 1.8rem;
            pointer-events: none;
            letter-spacing: 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* 地圖容器 */
        #map-container {
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #map-container:active {
            cursor: grabbing;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        /* 國家板塊樣式 */
        .country {
            stroke: #ffffff;
            stroke-width: 0.8px; 
            transition: fill 0.2s ease, stroke-width 0.1s ease;
            cursor: pointer;
            vector-effect: non-scaling-stroke;
        }

        /* 懸停效果：加上深色邊框 */
        .country:hover {
            stroke: var(--highlight-stroke);
            stroke-width: 1.5px;
            z-index: 10;
        }

        /* 陸地陰影 (Drop Shadow) */
        .land-layer {
            filter: drop-shadow(0px 4px 8px rgba(0, 0, 0, 0.2));
        }

        /* 海洋文字 - 放大並增強 */
        .ocean-label {
            fill: #0277BD; /* 深海藍 */
            font-size: 26px; /* 放大字體 */
            font-weight: 900; /* 極粗 */
            letter-spacing: 8px; /* 寬字距 */
            opacity: 0.9; 
            pointer-events: none;
            text-anchor: middle;
            font-style: italic;
            user-select: none;
            text-shadow: 
                3px 3px 0px #fff, 
                -2px -2px 0 #fff,  
                2px -2px 0 #fff,
                -2px 2px 0 #fff,
                2px 2px 0 #fff;
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(33, 33, 33, 0.95);
            color: #fff;
            padding: 12px 18px;
            border-radius: 6px;
            font-size: 16px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
            z-index: 20;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            text-align: left;
            transform: translate(20px, 20px);
            border: 1px solid rgba(255,255,255,0.15);
        }
        #tooltip .en-sub {
            display: block;
            font-size: 13px;
            color: #B0BEC5;
            margin-top: 4px;
            font-weight: 300;
        }

        /* Modal 樣式 */
        #info-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #info-modal.active { display: flex; opacity: 1; }
        .modal-card {
            background: var(--modal-bg);
            width: 90%; max-width: 750px; max-height: 85vh;
            border-radius: 16px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
            transform: translateY(30px);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #info-modal.active .modal-card { transform: translateY(0); }
        .modal-header {
            padding: 25px 30px; background: #FAFAFA; border-bottom: 1px solid #EEEEEE; position: relative;
        }
        .modal-header h2 { margin: 0; color: var(--text-primary); font-size: 30px; }
        .modal-header .en-title { color: var(--text-secondary); font-size: 18px; margin-top: 5px; font-weight: 400; }
        .close-btn {
            position: absolute; top: 25px; right: 25px; font-size: 32px; color: #B0BEC5; cursor: pointer; line-height: 1; transition: color 0.2s;
        }
        .close-btn:hover { color: #37474F; }
        .modal-body { padding: 30px; overflow-y: auto; line-height: 1.8; color: #455A64; font-size: 16px; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 30px; padding-bottom: 25px; border-bottom: 1px dashed #CFD8DC; }
        .stat-box { flex: 1; background: #F1F8E9; padding: 18px; border-radius: 10px; text-align: center; border: 1px solid #DCEDC8; }
        .stat-box:nth-child(2) { background: #E1F5FE; border-color: #B3E5FC; }
        .stat-box:nth-child(3) { background: #FFF3E0; border-color: #FFE0B2; }
        .stat-box strong { display: block; font-size: 13px; color: #78909C; text-transform: uppercase; margin-bottom: 8px; }
        .stat-box span { font-size: 18px; color: #263238; font-weight: 800; display: block; line-height: 1.2; } /* 調整 Capital 字體適應雙語 */
        
        .history-content h3 { margin-top: 0; font-size: 20px; color: #0277BD; border-left: 5px solid #0277BD; padding-left: 15px; margin-bottom: 15px; }
        .history-content p { margin-bottom: 15px; }
        .source-note { margin-top: 30px; font-size: 13px; color: #90A4AE; text-align: right; border-top: 1px solid #EEEEEE; padding-top: 15px; }
        
        /* Spinner & Loader */
        .spinner { display: inline-block; width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: #039BE5; animation: spin 0.8s ease-in-out infinite; vertical-align: middle; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }

        @media (max-width: 600px) { .stats-row { flex-direction: column; gap: 10px; } h1 { font-size: 1.2rem; padding: 8px 20px; } }
    </style>
</head>
<body>

    <h1>互動式世界地圖</h1>

    <div id="loader">
        <div class="spinner" style="width: 50px; height: 50px; border-width: 5px;"></div>
        <p style="margin-top: 20px; color: #546E7A; font-weight: bold;">正在下載地圖與建立資料庫...</p>
    </div>

    <div id="tooltip">
        <strong id="tt-zh"></strong>
        <span id="tt-en" class="en-sub"></span>
    </div>

    <div id="map-container"></div>

    <div id="info-modal" onclick="closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="close-btn" onclick="closeModal()">&times;</span>
                <h2 id="m-name-zh">國家名稱</h2>
                <div id="m-name-en" class="en-title">Country Name</div>
            </div>
            <div class="modal-body">
                <div class="stats-row">
                    <div class="stat-box"><strong>首都 Capital</strong><span id="m-capital">--</span></div>
                    <div class="stat-box"><strong>人口 Population</strong><span id="m-pop">--</span></div>
                    <div class="stat-box"><strong>面積 Area (km²)</strong><span id="m-area">--</span></div>
                </div>
                <div class="history-content">
                    <h3>簡要歷史與概況</h3>
                    <div id="m-history">載入中...</div>
                </div>
                <div class="source-note">資料來源：RestCountries API 與 維基百科 (Wikipedia)</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. 繁體中文國名對照表 ---
        const zhCountryNames = {
            "AFG":"阿富汗", "AGO":"安哥拉", "ALB":"阿爾巴尼亞", "ARE":"阿聯酋", "ARG":"阿根廷", "ARM":"亞美尼亞", "ATA":"南極洲", "ATF":"法屬南部領地", "AUS":"澳洲", "AUT":"奧地利", "AZE":"亞塞拜然",
            "BDI":"蒲隆地", "BEL":"比利時", "BEN":"貝南", "BFA":"布吉納法索", "BGD":"孟加拉", "BGR":"保加利亞", "BHR":"巴林", "BHS":"巴哈馬", "BIH":"波士尼亞與赫塞哥維納", "BLR":"白俄羅斯", "BLZ":"貝里斯", "BOL":"玻利維亞", "BRA":"巴西", "BRB":"巴貝多", "BRN":"汶萊", "BTN":"不丹", "BWA":"波札那",
            "CAF":"中非共和國", "CAN":"加拿大", "CHE":"瑞士", "CHL":"智利", "CHN":"中國", "CIV":"象牙海岸", "CMR":"喀麥隆", "COD":"剛果民主共和國", "COG":"剛果共和國", "COL":"哥倫比亞", "COM":"葛摩", "CPV":"維德角", "CRI":"哥斯大黎加", "CUB":"古巴", "CYP":"賽普勒斯", "CZE":"捷克",
            "DEU":"德國", "DJI":"吉布地", "DMA":"多米尼克", "DNK":"丹麥", "DOM":"多明尼加", "DZA":"阿爾及利亞",
            "ECU":"厄瓜多", "EGY":"埃及", "ERI":"厄利垂亞", "ESP":"西班牙", "EST":"愛沙尼亞", "ETH":"衣索比亞",
            "FIN":"芬蘭", "FJI":"斐濟", "FLK":"福克蘭群島", "FRA":"法國", "GAB":"加彭", "GBR":"英國", "GEO":"喬治亞", "GHA":"迦納", "GIN":"幾內亞", "GMB":"甘比亞", "GNB":"幾內亞比索", "GNQ":"赤道幾內亞", "GRC":"希臘", "GRL":"格陵蘭", "GTM":"瓜地馬拉", "GUY":"蓋亞那",
            "HND":"宏都拉斯", "HRV":"克羅埃西亞", "HTI":"海地", "HUN":"匈牙利",
            "IDN":"印尼", "IND":"印度", "IRL":"愛爾蘭", "IRN":"伊朗", "IRQ":"伊拉克", "ISL":"冰島", "ISR":"以色列", "ITA":"義大利",
            "JAM":"牙買加", "JOR":"約旦", "JPN":"日本",
            "KAZ":"哈薩克", "KEN":"肯亞", "KGZ":"吉爾吉斯", "KHM":"柬埔寨", "KOR":"南韓", "KWT":"科威特",
            "LAO":"寮國", "LBN":"黎巴嫩", "LBR":"賴比瑞亞", "LBY":"利比亞", "LKA":"斯里蘭卡", "LSO":"賴索托", "LTU":"立陶宛", "LUX":"盧森堡", "LVA":"拉脫維亞",
            "MAR":"摩洛哥", "MDA":"摩爾多瓦", "MDG":"馬達加斯加", "MEX":"墨西哥", "MKD":"北馬其頓", "MLI":"馬利", "MMR":"緬甸", "MNE":"蒙特內哥羅", "MNG":"蒙古", "MOZ":"莫三比克", "MRT":"茅利塔尼亞", "MWI":"馬拉威", "MYS":"馬來西亞",
            "NAM":"納米比亞", "NCL":"新喀里多尼亞", "NER":"尼日", "NGA":"奈及利亞", "NIC":"尼加拉瓜", "NLD":"荷蘭", "NOR":"挪威", "NPL":"尼泊爾", "NZL":"紐西蘭",
            "OMN":"阿曼",
            "PAK":"巴基斯坦", "PAN":"巴拿馬", "PER":"秘魯", "PHL":"菲律賓", "PNG":"巴布亞紐幾內亞", "POL":"波蘭", "PRI":"波多黎各", "PRK":"北韓", "PRT":"葡萄牙", "PRY":"巴拉圭", "PSE":"巴勒斯坦",
            "QAT":"卡達",
            "ROU":"羅馬尼亞", "RUS":"俄羅斯", "RWA":"盧安達",
            "SAU":"沙烏地阿拉伯", "SDN":"蘇丹", "SEN":"塞內加爾", "SGP":"新加坡", "SLB":"索羅門群島", "SLE":"獅子山", "SLV":"薩爾瓦多", "SOM":"索馬利亞", "SRB":"塞爾維亞", "SSD":"南蘇丹", "STP":"聖多美普林西比", "SUR":"蘇利南", "SVK":"斯洛伐克", "SVN":"斯洛維尼亞", "SWE":"瑞典", "SWZ":"史瓦帝尼", "SYR":"敘利亞",
            "TCD":"查德", "TGO":"多哥", "THA":"泰國", "TJK":"塔吉克", "TKM":"土庫曼", "TLS":"東帝汶", "TTO":"千里達及托巴哥", "TUN":"突尼西亞", "TUR":"土耳其", "TWN":"台灣", "TZA":"坦尚尼亞",
            "UGA":"烏干達", "UKR":"烏克蘭", "URY":"烏拉圭", "USA":"美國", "UZB":"烏茲別克",
            "VEN":"委內瑞拉", "VNM":"越南", "VUT":"萬那杜",
            "YEM":"叶门", "ZAF":"南非", "ZMB":"尚比亞", "ZWE":"辛巴威"
        };

        // --- 2. 繁體中文首都對照表 (確保首都雙語顯示) ---
        const zhCapitals = {
            "AFG": "喀布爾", "AGO": "魯安達", "ALB": "地拉那", "ARE": "阿布達比", "ARG": "布宜諾斯艾利斯", "ARM": "葉里溫", "ATA": "", "ATF": "法蘭西港", "AUS": "坎培拉", "AUT": "維也納", "AZE": "巴庫",
            "BDI": "基特加", "BEL": "布魯塞爾", "BEN": "新港", "BFA": "瓦加杜古", "BGD": "達卡", "BGR": "索菲亞", "BHR": "麥納瑪", "BHS": "拿索", "BIH": "塞拉耶佛", "BLR": "明斯克", "BLZ": "貝爾墨邦", "BOL": "蘇克雷", "BRA": "巴西利亞", "BRB": "布里奇敦", "BRN": "斯里巴加灣市", "BTN": "廷布", "BWA": "嘉柏隆里",
            "CAF": "班基", "CAN": "渥太華", "CHE": "伯恩", "CHL": "聖地牙哥", "CHN": "北京", "CIV": "雅穆索戈", "CMR": "雅溫德", "COD": "金夏沙", "COG": "布拉薩", "COL": "波哥大", "COM": "莫洛尼", "CPV": "普拉亞", "CRI": "聖荷西", "CUB": "哈瓦那", "CYP": "尼科西亞", "CZE": "布拉格",
            "DEU": "柏林", "DJI": "吉布地市", "DMA": "羅索", "DNK": "哥本哈根", "DOM": "聖多明哥", "DZA": "阿爾及爾",
            "ECU": "基多", "EGY": "開羅", "ERI": "阿斯馬拉", "ESP": "馬德里", "EST": "塔林", "ETH": "阿迪斯阿貝巴",
            "FIN": "赫爾辛基", "FJI": "蘇瓦", "FLK": "史坦利", "FRA": "巴黎", "GAB": "利伯维尔", "GBR": "倫敦", "GEO": "提比里斯", "GHA": "阿克拉", "GIN": "科納克里", "GMB": "班竹", "GNB": "比索", "GNQ": "馬拉博", "GRC": "雅典", "GRL": "努克", "GTM": "瓜地馬拉市", "GUY": "喬治敦",
            "HND": "特古西加爾巴", "HRV": "札格瑞布", "HTI": "太子港", "HUN": "布達佩斯",
            "IDN": "雅加達", "IND": "新德里", "IRL": "都柏林", "IRN": "德黑蘭", "IRQ": "巴格達", "ISL": "雷克雅維克", "ISR": "耶路撒冷", "ITA": "羅馬",
            "JAM": "京斯敦", "JOR": "安曼", "JPN": "東京",
            "KAZ": "阿斯塔納", "KEN": "奈洛比", "KGZ": "比斯凱克", "KHM": "金邊", "KOR": "首爾", "KWT": "科威特市",
            "LAO": "永珍", "LBN": "貝魯特", "LBR": "蒙羅維亞", "LBY": "的黎波里", "LKA": "斯里賈亞瓦德納普拉科特", "LSO": "馬塞盧", "LTU": "維爾紐斯", "LUX": "盧森堡市", "LVA": "里加",
            "MAR": "拉巴特", "MDA": "基希訥烏", "MDG": "安塔那那利佛", "MEX": "墨西哥城", "MKD": "史高比耶", "MLI": "巴馬科", "MMR": "奈比多", "MNE": "波德里查", "MNG": "烏蘭巴托", "MOZ": "馬普托", "MRT": "諾克少", "MWI": "里隆威", "MYS": "吉隆坡",
            "NAM": "溫荷克", "NCL": "努美阿", "NER": "尼亞美", "NGA": "阿布賈", "NIC": "馬拿瓜", "NLD": "阿姆斯特丹", "NOR": "奧斯陸", "NPL": "加德滿都", "NZL": "威靈頓",
            "OMN": "馬斯喀特",
            "PAK": "伊斯蘭馬巴德", "PAN": "巴拿馬城", "PER": "利馬", "PHL": "馬尼拉", "PNG": "莫爾茲比港", "POL": "華沙", "PRI": "聖胡安", "PRK": "平壤", "PRT": "里斯本", "PRY": "亞松森", "PSE": "拉姆安拉",
            "QAT": "杜哈",
            "ROU": "布加勒斯特", "RUS": "莫斯科", "RWA": "吉佳利",
            "SAU": "利雅德", "SDN": "喀土穆", "SEN": "達卡", "SGP": "新加坡", "SLB": "荷尼阿拉", "SLE": "弗里敦", "SLV": "聖薩爾瓦多", "SOM": "摩加迪休", "SRB": "貝爾格勒", "SSD": "朱巴", "STP": "聖多美", "SUR": "巴拉馬利波", "SVK": "布拉提斯拉瓦", "SVN": "盧布爾雅那", "SWE": "斯德哥爾摩", "SWZ": "墨巴本", "SYR": "大馬士革",
            "TCD": "恩將納", "TGO": "洛美", "THA": "曼谷", "TJK": "杜尚別", "TKM": "阿什哈巴德", "TLS": "帝力", "TTO": "西班牙港", "TUN": "突尼斯", "TUR": "安卡拉", "TWN": "台北", "TZA": "杜杜馬",
            "UGA": "坎帕拉", "UKR": "基輔", "URY": "蒙特維多", "USA": "華盛頓特區", "UZB": "塔什干",
            "VEN": "卡拉卡斯", "VNM": "河內", "VUT": "維拉港",
            "YEM": "沙那", "ZAF": "普勒托利亞", "ZMB": "路沙卡", "ZWE": "哈拉雷"
        };


        // --- 3. 顏色與變數 ---
        const width = window.innerWidth;
        const height = window.innerHeight;
        
        // **預設顏色 (Base Colors)**：飽和度適中的粉彩對比色
        const baseContinentColors = {
            "Asia": "#FFE082",       // 琥珀黃
            "Europe": "#81D4FA",     // 天藍色
            "Africa": "#A5D6A7",     // 草綠色
            "Oceania": "#CE93D8",    // 紫羅蘭
            "Americas": "#EF9A9A",   // 柔和紅
            "Polar": "#B0BEC5",      // 銀灰
            "default": "#CFD8DC"
        };

        // **懸停顏色 (Hover Colors)**：高對比鮮豔色
        const hoverContinentColors = {
            "Asia": "#FFB300",       
            "Europe": "#039BE5",     
            "Africa": "#43A047",     
            "Oceania": "#8E24AA",    
            "Americas": "#E53935",   
            "Polar": "#78909C",      
            "default": "#78909C"
        };

        let restCountryData = {};

        // --- 4. 初始化地圖 ---
        const svg = d3.select("#map-container")
            .append("svg")
            .attr("viewBox", `0 0 ${width} ${height}`)
            .attr("preserveAspectRatio", "xMidYMid meet");

        const projection = d3.geoNaturalEarth1()
            .scale(width / 5.5)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        const g = svg.append("g");
        const landGroup = g.append("g").attr("class", "land-layer");
        const oceanTextGroup = g.append("g").attr("class", "ocean-layer");

        const zoom = d3.zoom()
            .scaleExtent([1, 8])
            .on("zoom", (e) => g.attr("transform", e.transform));
        svg.call(zoom);

        const tooltip = d3.select("#tooltip");

        // --- 5. 讀取與處理資料 ---
        const mapUrl = "https://unpkg.com/world-atlas@2.0.2/countries-50m.json";
        const apiStatsUrl = "https://restcountries.com/v3.1/all?fields=ccn3,cca3,name,capital,population,area,region,subregion";

        Promise.all([
            d3.json(mapUrl),
            d3.json(apiStatsUrl)
        ]).then(([topoData, apiData]) => {
            
            apiData.forEach(c => {
                if (c.ccn3) restCountryData[c.ccn3] = c;
            });

            const countries = topojson.feature(topoData, topoData.objects.countries).features;

            landGroup.selectAll("path")
                .data(countries)
                .enter().append("path")
                .attr("class", "country")
                .attr("d", path)
                .attr("fill", d => {
                    // 使用 Base 顏色
                    const info = restCountryData[d.id];
                    const region = info ? info.region : "default";
                    return baseContinentColors[region] || baseContinentColors["default"];
                })
                .on("mouseover", function(event, d) {
                    // 變色為 Hover (鮮豔) 顏色
                    const info = restCountryData[d.id];
                    const region = info ? info.region : "default";
                    const activeColor = hoverContinentColors[region] || hoverContinentColors["default"];
                    d3.select(this).style("fill", activeColor);
                    
                    // Tooltip
                    const infoData = getCountryDisplayData(d.id);
                    d3.select("#tt-zh").text(infoData.nameZh);
                    d3.select("#tt-en").text(infoData.nameEn);
                    tooltip.style("opacity", 1);
                })
                .on("mousemove", (event) => {
                    tooltip.style("left", (event.pageX) + "px").style("top", (event.pageY) + "px");
                })
                .on("mouseout", function(event, d) {
                    // 恢復為 Base 顏色
                    const info = restCountryData[d.id];
                    const region = info ? info.region : "default";
                    const baseColor = baseContinentColors[region] || baseContinentColors["default"];
                    d3.select(this).style("fill", baseColor);
                    
                    tooltip.style("opacity", 0);
                })
                .on("click", (event, d) => openModal(d));

            const oceans = [
                { name: "太 平 洋", coords: [160, 0] },
                { name: "大 西 洋", coords: [-30, 0] },
                { name: "印 度 洋", coords: [80, -10] },
                { name: "北 冰 洋", coords: [0, 85] },
                { name: "南 冰 洋", coords: [0, -60] }
            ];

            oceanTextGroup.selectAll("text")
                .data(oceans)
                .enter().append("text")
                .attr("class", "ocean-label")
                .attr("transform", d => `translate(${projection(d.coords)})`)
                .text(d => d.name);

            document.getElementById("loader").style.opacity = 0;
            setTimeout(() => document.getElementById("loader").remove(), 500);

        }).catch(err => {
            console.error(err);
            document.getElementById("loader").innerHTML = "<p>資料載入錯誤，請檢查網路連線。</p>";
        });


        // --- 6. 輔助函式 ---
        function getCountryDisplayData(geoId) {
            const apiInfo = restCountryData[geoId];
            let nameZh = "未知地區", nameEn = "Unknown", cca3 = null;
            if (apiInfo) {
                cca3 = apiInfo.cca3;
                nameEn = apiInfo.name.common;
                if (cca3 && zhCountryNames[cca3]) nameZh = zhCountryNames[cca3];
                else if (apiInfo.translations && apiInfo.translations.zho) nameZh = apiInfo.translations.zho.common;
                else nameZh = nameEn;
            }
            return { nameZh, nameEn, apiInfo, cca3 };
        }

        // --- 7. Modal 與 Wiki ---
        function openModal(geoData) {
            const { nameZh, nameEn, apiInfo, cca3 } = getCountryDisplayData(geoData.id);
            const modal = document.getElementById("info-modal");
            const historyDiv = document.getElementById("m-history");

            document.getElementById("m-name-zh").innerText = nameZh;
            document.getElementById("m-name-en").innerText = nameEn;

            if (apiInfo) {
                // 首都 (Capital) 處理邏輯：
                // 1. 取得 API 的英文首都名
                const capEn = apiInfo.capital ? apiInfo.capital[0] : "無";
                // 2. 嘗試從字典查中文首都名
                let capZh = capEn; // 預設為英文
                if (cca3 && zhCapitals[cca3]) {
                    capZh = zhCapitals[cca3];
                }
                
                // 3. 顯示格式：若有中文且不同於英文，則顯示 "中文 英文"
                // 若無中文翻譯，或中文等於英文，則只顯示英文
                if (capZh !== capEn && capEn !== "無") {
                    document.getElementById("m-capital").innerText = `${capZh} ${capEn}`;
                } else {
                    document.getElementById("m-capital").innerText = capEn;
                }

                document.getElementById("m-pop").innerText = apiInfo.population ? apiInfo.population.toLocaleString() : "--";
                document.getElementById("m-area").innerText = apiInfo.area ? apiInfo.area.toLocaleString() : "--";
            } else {
                document.getElementById("m-capital").innerText = "--"; 
                document.getElementById("m-pop").innerText = "--"; 
                document.getElementById("m-area").innerText = "--";
            }

            modal.classList.add("active");
            historyDiv.innerHTML = '<span class="spinner"></span> 正在整理維基百科資料...';

            if (nameZh === "未知地區") { historyDiv.innerHTML = "無相關歷史資料。"; return; }
            fetchWikipediaSummary(nameZh);
        }

        function fetchWikipediaSummary(queryTitle) {
            const historyDiv = document.getElementById("m-history");
            const endpoint = "https://zh.wikipedia.org/w/api.php";
            const params = new URLSearchParams({
                action: "query", format: "json", prop: "extracts", exintro: "true", explaintext: "true", variant: "zh-tw", redirects: "1", origin: "*", titles: queryTitle
            });

            fetch(`${endpoint}?${params.toString()}`)
                .then(res => res.json())
                .then(data => {
                    const pages = data.query.pages;
                    const pageId = Object.keys(pages)[0];
                    if (pageId === "-1") {
                        historyDiv.innerHTML = "抱歉，維基百科暫無此國家/地區的中文摘要資料。";
                    } else {
                        let extract = pages[pageId].extract;
                        if (extract) {
                            const formattedText = extract.split("\n").map(p => p.trim().length > 0 ? `<p>${p}</p>` : "").join("");
                            historyDiv.innerHTML = formattedText;
                        } else {
                            historyDiv.innerHTML = "無法獲取文字內容。";
                        }
                    }
                })
                .catch(err => {
                    console.error("Wiki API Error:", err);
                    historyDiv.innerHTML = "連線維基百科失敗，無法獲取歷史資料。";
                });
        }

        function closeModal() { document.getElementById("info-modal").classList.remove("active"); }

        window.addEventListener("resize", () => {
            const w = window.innerWidth, h = window.innerHeight;
            svg.attr("viewBox", `0 0 ${w} ${h}`);
            projection.translate([w/2, h/2]).scale(w/5.5);
            landGroup.selectAll("path").attr("d", path);
            oceanTextGroup.selectAll("text").attr("transform", d => `translate(${projection(d.coords)})`);
        });

    </script>
</body>
</html>